name: 'zsh Action'
description: 'Execute commands in a properly initialized zsh environment'
inputs:
  run:
    description: 'Commands to run in ZSh'
    required: true
  as_user:
    description: 'User to run the commands as (optional)'
    required: false
    default: ""
outputs:
  exit_code:
    description: 'The exit code of the commands'
    value: ${{ steps.zsh-run.outputs.exit_code }}
runs:
  using: 'composite'
  steps:
    - name: Execute commands in zsh
      id: zsh-run
      shell: zsh
      run: |
        TEMP_SCRIPT=$(mktemp)
        trap 'rm -f "${TEMP_SCRIPT}"' EXIT
        echo "${{ inputs.run }}" > "${TEMP_SCRIPT}"

        # load profile if exists
        [ -f ~/.zshrc ] && source ~/.zshrc

        if [ -n "${{ inputs.as_user }}" ]; then
          chmod o+r "${TEMP_SCRIPT}"
          sudo -u "${{ inputs.as_user }}" zsh "${TEMP_SCRIPT}"
        else
          source "${TEMP_SCRIPT}"
        fi

        echo "exit_code=$?" >> $GITHUB_OUTPUT